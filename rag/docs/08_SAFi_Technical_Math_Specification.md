---
title: SAFi Explained: The Formal Mathematical Specification
slug: technical-math-specification
tags: ["safi", "reference", "math", "specification"]
summary: Formal mathematical and technical specification for SAFi: objects, timing, data flow, pseudocode, and Spirit formulas.
version: 1.0
---

# SAFi Explained: The Formal Mathematical Specification

### **Core Concept: The Purpose of this Document**

**Q: What is the purpose of the SAFi Formal Specification?**

A: This document provides the precise, formal mathematical and technical specification for the Self-Alignment Framework Interface (SAFi). It is the engineering blueprint that defines the core objects, data flow, timing model, formulas, and pseudocode for the implementation. It complements the other, more conceptual documents.

### **Core Mathematical Objects**

**Q: What are the core mathematical objects in the SAFi specification?**

A: The core objects are:

- **t**: The discrete interaction index (the turn number).
- **x_t**: The input context from the user (prompt, metadata).
- **V = {(v_i, w_i)}**: The declared set of values, each with a corresponding weight (w_i), where the sum of all weights is 1.
- **a_t**: The draft action or answer generated by the Intellect.
- **D_t**: The Will's gate decision, which can be approve or violation.
- **E_t**: The Will’s reason or explanation for its decision.
- **L_t**: The Conscience's Ledger, a record of scores (s) and confidences (c) for each value.
- **S_t**: The Spirit's coherence score for the current turn.
- **M_t**: The system's memory of prior audits and running aggregates.

### **System Architecture and Data Flow**

**Q: What is the timing model for the SAFi faculties?**

A: SAFi uses a hybrid timing model:

- **Synchronous (user waits):** The **Intellect** and **Will** faculties operate synchronously. The user does not receive a response until the Will makes its approve or violation decision.
- **Asynchronous (background process):** The **Conscience** and **Spirit** faculties operate asynchronously in the background after a response has been sent to the user.

**Q: What is the data flow for an approved response?**

A: For an approved response, the synchronous chain is Intellect -> Will -> User. The asynchronous chain that follows is Conscience -> Spirit -> Memory update.

**Q: What is the pseudocode for the SAFi loop?**

A:

```python
# Synchronous Path (user is waiting)
draft, reflection = Intellect(prompt, values, memory)
decision, reason = Will(draft, prompt, values, reflection)

if decision == "violation":
    return safe_reply(reason)
    log_event(prompt, draft, decision, reason)
else:
    # User sees the answer now
    return draft
    # Enqueue the background audit job
    enqueue_audit_job(prompt, draft, values, memory)

# Asynchronous Audit Worker (happens in background)
def run_audit(job):
    # Conscience Phase
    ledger = Conscience(job.draft, job.prompt, job.values)

    # Spirit Phase
    spirit_score = calculate_spirit_score(ledger, job.values)
    projection_vector = create_projection_vector(ledger, job.values)
    new_memory_vector = update_memory_vector(job.memory.mu, projection_vector)
    drift = calculate_drift(projection_vector, job.memory.mu)

    # Store results and update memory
    store_audit_results(ledger, spirit_score, drift)
    update_system_memory(new_memory_vector)

    # Check for alerts
    if spirit_score < alert_threshold or drift > drift_threshold:
        raise_alert(reasons=get_offending_values(ledger))
```

### **Key Formulas and Parameters**

**Q: What are the key mathematical formulas used by the Spirit?**

A: The Spirit uses three key formulas:

1. **Spirit Score (S_t):** S_t = σ( Σ [w_i · s_{i,t} · φ(c_{i,t})] )
2. **Memory Update (μ_t):** μ_t = β * μ_{t−1} + (1−β) * p_t
3. **Drift (d_t):** d_t = 1 − cos_sim(p_t, μ_{t−1})

**Q: What are the key configurable parameters in the SAFi model?**

A: The key parameters that can be tuned are:

- **Score Alphabet:** The mapping of qualitative judgments to numerical scores (e.g., Violates = -1).
- **Confidence (c):** The confidence score range, typically [0,1].
- **σ (sigma):** A scaling function for the Spirit Score.
- **φ(c) (phi of c):** A function to down-weight low-confidence audits.
- **β (beta):** The smoothing factor that controls the "memory length" of the Spirit.
- **τ_S, τ_d (tau):** The alert thresholds for low Spirit Scores or high Drift.

## Cross refs
- 03 Faculties Intellect
- 04 Faculties Will
- 05 Faculties Conscience
- 06 Faculties Spirit
